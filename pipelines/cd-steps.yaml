secrets:
  - id: username
    keyvault: https://delphivault.vault.azure.net/secrets/UserName
  - id: password
    keyvault: https://delphivault.vault.azure.net/secrets/Password
  - id: clientid
    keyvault: https://delphivault.vault.azure.net/secrets/client_id
  - id: clientsecret
    keyvault: https://delphivault.vault.azure.net/secrets/client_secret
  - id: tenantid
    keyvault: https://delphivault.vault.azure.net/secrets/tenant_id


steps:
- checkout: none
- task: HelmInstaller@1
  displayName: 'install helm'
  inputs:
    helmVersionToInstall: $(helmVersion)
- download: ci-pipeline
  artifact: build-artifact
- bash: |
   az login \
        --service-principal \
        -u $(clientid) \
        -p $(clientsecret) \
        --tenant $(tenantid)
    az aks get-credentials \
        -n $(aks) \
        -g $(rg)
    acrlogin_password=$(az keyvault secret show -n Password --vault-name delphivault | jq -r '.value')
    helm repo add \
        $(registryName) \
        https://$(registryServerName)/helm/v1/repo \
        --username $(acrlogin_username) \
        --password $(acrlogin_password)
    helmChartVersion=$(jq .helmChartVersion $(pipeline.workspace)/ci-pipeline/build-artifact/variables.json -r)
    helm upgrade \
        --namespace $(k8sNamespace) \
        --install \
        --wait \
        --version $helmChartVersion \
        --set image.repository=$(registryServerName)/$(projectName) \
        --set ingress.enabled=false \
        $(projectName) \
        $(registryName)/$(projectName)
  failOnStderr: true
  displayName: 'deploy helm chart'